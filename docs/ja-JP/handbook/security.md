# NocoBase セキュリティガイド

NocoBaseは、機能設計からシステム実装まで、データとアプリケーションの安全性に重点を置いています。プラットフォームには、ユーザー認証、アクセス制御、データ暗号化などの複数のセキュリティ機能が組み込まれており、実際のニーズに応じてセキュリティポリシーを柔軟に設定できます。ユーザーデータの保護、アクセス権限の管理、開発環境と本番環境の分離など、NocoBaseは実用的なツールとソリューションを提供しています。このガイドは、NocoBaseを安全に使用するためのガイダンスを提供し、ユーザーがデータ、アプリケーション、環境の安全性を保護し、ユーザーの安全を確保しながらシステム機能を効率的に使用できるよう支援することを目的としています。

## ユーザー認証

ユーザー認証は、ユーザーの身元を識別し、未承認のユーザーがシステムにアクセスするのを防ぎ、ユーザーの身元が悪用されないようにするために使用されます。

### Token 戦略

デフォルトでは、NocoBaseはJWT（JSON Web Token）を使用してサーバーAPIを認証し、以下のToken戦略を設定できます：

| 設定項目              | 説明                                                                                                                                                                                  |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| セッション有効期間          | ユーザーがログインするたびに有効な最大時間。セッション有効期間内にTokenが自動更新され、タイムアウト後はユーザーに再ログインを要求します。                                                                                                |
| Token 有効期間        | 発行されたAPI Tokenの有効期間。Tokenが期限切れになった場合、セッション有効期間内で、かつリフレッシュ時間制限を超えていない場合、サーバーは自動的に新しいTokenを発行してユーザーセッションを維持します。それ以外の場合はユーザーに再ログインを要求します。（各Tokenは1回のみリフレッシュ可能） |
| 期限切れTokenリフレッシュ時間制限 | Tokenが期限切れになった後にリフレッシュを許可する最大時間                                                                                                                                                        |

通常、管理者には以下を推奨します：

- Tokenの露出時間を制限するために、短いToken有効期間を設定します。
- ユーザーエクスペリエンスとセキュリティのバランスを取るために、Token有効期間より長いが過度に長くない適切なセッション有効期間を設定します。Token自動リフレッシュメカニズムを利用して、アクティブなユーザーセッションを中断せずに、長期間のセッションが悪用されるリスクを減らします。
- ユーザーが長時間非アクティブな場合にTokenが自然に期限切れになり、新しいTokenが発行されないように、適切な期限切れTokenリフレッシュ時間制限を設定します。これにより、ユーザーのアイドルセッションが悪用されるリスクを低減します。

![](https://static-docs.nocobase.com/202501031613500.png)

### Token クライアントストレージ

デフォルトでは、ユーザーTokenはブラウザのLocalStorageに保存されます。ブラウザページを閉じて再度開いた場合、Tokenが有効期限内であれば、ユーザーは再ログインする必要はありません。

ユーザーが毎回ページにアクセスする際に再ログインを要求したい場合は、環境変数 `API_CLIENT_STORAGE_TYPE=sessionStorage` を設定し、ユーザーTokenをブラウザのSessionStorageに保存することで、ユーザーが毎回ページを開く際に再ログインを要求するようにできます。

### パスワードポリシー

> プロフェッショナル版以上

NocoBaseは、すべてのユーザーに対してパスワードルールとパスワードログイン試行ロックポリシーを設定し、パスワードログインが有効なNocoBaseアプリケーションのセキュリティを強化します。各設定項目については[パスワードポリシー](./password-policy/index.md)を参照してください。

#### パスワードルール

| 設定項目                     | 説明                                                     |
| -------------------------- | -------------------------------------------------------- |
| **パスワード長**               | パスワードの最小長さ要件、最大長さは64。                      |
| **パスワード複雑度**             | パスワードの複雑度要件、含める必要のある文字種。               |
| **パスワードにユーザー名を含めない** | パスワードに現在のユーザー名を含めることができるかどうかを設定します。                     |
| **パスワード履歴を記憶**           | ユーザーが最近使用したパスワードの数を記憶し、ユーザーがパスワードを変更する際に再利用できないようにします。 |

#### パスワード有効期限設定

| 設定項目                   | 説明                                                                                                                                   |
| ------------------------ | -------------------------------------------------------------------------------------------------------------------------------------- |
| **パスワード有効期間**           | ユーザーパスワードの有効期間。パスワードが期限切れになると、管理者がパスワードを再設定する必要があります。ユーザーは他のログイン方法を使用してログインできます。 |
| **パスワード有効期限切れ通知チャネル** | ユーザーパスワードが期限切れになる10日前から、ユーザーがログインするたびに通知を送信します。                                                                                     |

#### パスワードログインセキュリティ

| 設定項目                             | 説明                                                                                                                                |
| ---------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **最大無効パスワードログイン試行回数**       | ユーザーが指定された時間間隔内にログインを試行できる最大回数を設定します。                                                                                      |
| **最大無効パスワードログイン時間間隔（秒）** | ユーザーの最大無効ログイン回数を計算する時間間隔を設定します。単位は秒。                                                                                  |
| **ロック時間（秒）**                 | ユーザーが無効パスワードログイン制限を超えた場合のロック時間を設定します（0は制限なし）。<br>ユーザーがロックされている間は、APIキーを含むすべての認証方法でシステムにアクセスできなくなります。 |

通常、以下を推奨します：

- パスワードが関連性推測やブルートフォース攻撃を受けるリスクを低減するために、強度の高いパスワードルールを設定します。
- ユーザーに定期的にパスワードを変更させるために、適切なパスワード有効期間を設定します。
- 無効パスワードログイン回数と時間設定を組み合わせて、短時間内の高頻度のパスワードログイン試行を制限し、ブルートフォース攻撃を防止します。
- セキュリティ要件が厳しい環境では、ログイン制限を超えた場合のユーザーロック時間を適切に設定します。ただし、ロック時間の設定は悪用される可能性があり、攻撃者がターゲットアカウントに対して意図的に複数回間違ったパスワードを入力してアカウントをロックし、正常な使用を妨げる可能性があります。実際の使用では、IP制限やAPI頻度制限などの手段を組み合わせて、このような攻撃を防ぐことができます。
- また、パスワードが期限切れになったりアカウントがロックされたりすると、管理者アカウントを含むすべてのアカウントがシステムにアクセスできなくなるため、システム内に複数のパスワードリセットやユーザーのロック解除権限を持つアカウントを設定することをお勧めします。

![](https://static-docs.nocobase.com/202501031618900.png)

### ユーザーロック

> プロフェッショナル版以上、パスワードポリシープラグインに含まれる

無効パスワードログイン制限を超えてロックされたユーザーを管理し、手動でロックを解除したり、異常なユーザーをロックリストに追加したりできます。ユーザーがロックされると、APIキーを含むすべての認証方法でシステムにアクセスできなくなります。

![](https://static-docs.nocobase.com/202501031618399.png)

### シングルサインオン (Single Sign-On)

> 商用プラグイン

NocoBaseは、OIDC、SAML 2.0、LDAP、CASなどの主要なプロトコルをサポートする豊富なSSO認証プラグインを提供しています。また、NocoBaseには認証方式の拡張インターフェースも完備されており、他の認証タイプを迅速に開発および統合できます。ユーザーは既存のIdPをNocoBaseに簡単に接続し、IdP上でユーザーIDを集中管理してセキュリティを向上させることができます。
![](https://static-docs.nocobase.com/202501031619427.png)

### 二要素認証 (Two-factor authentication)

> エンタープライズ版

二要素認証では、ユーザーがパスワードでログインする際に、信頼できるデバイスに送信されるワンタイム動的認証コードなど、2番目の身元証明情報を提供する必要があります。これにより、ユーザーの身元が悪用されるのを防ぎ、パスワード漏洩によるリスクを低減します。

### IP アクセス制御

> エンタープライズ版

NocoBaseは、ユーザーのアクセスIPにブラックリストまたはホワイトリストを設定できます。

- セキュリティ要件が厳しい環境では、IPホワイトリストを設定し、特定のIPまたはIP範囲のみがシステムにアクセスできるようにして、未承認の外部ネットワーク接続を制限し、セキュリティリスクを低減します。
- 公開されたネットワークアクセス条件下で、管理者が異常なアクセスを発見した場合、IPブラックリストを設定して、既知の悪意のあるIPアドレスや疑わしいソースからのアクセスをブロックし、悪意のあるスキャンやブルートフォース攻撃などのセキュリティ脅威を減らすことができます。
- 拒否されたアクセス要求については、ログ記録を保持します。

## 権限制御

システム内で異なるロールを設定し、ロールに応じた権限を設定することで、ユーザーがリソースにアクセスする権限を細かく制御できます。管理者は、実際のシナリオに応じて適切に設定し、システムリソースの漏洩リスクを低減する必要があります。

### ロールと権限

NocoBaseは、システム内でロールを設定し、異なるロールに権限を付与し、ユーザーを対応するロールにバインドすることで、ユーザーがリソースにアクセスする権限を制御します。各ユーザーは複数のロールを持つことができ、ユーザーはロールを切り替えて異なる視点でリソースを操作できます。部門プラグインをインストールしている場合、ロールを部門にバインドすることもでき、ユーザーは所属部門にバインドされたロールを持つことができます。

![](https://static-docs.nocobase.com/202501031620965.png)

### システム設定権限

システム設定権限には以下の設定が含まれます：

- 設定インターフェースを許可するかどうか
- プラグインのインストール、有効化、無効化を許可するかどうか
- プラグインの設定を許可するかどうか
- キャッシュのクリア、アプリケーションの再起動を許可するかどうか
- 各プラグインの設定権限

### メニュー権限

メニュー権限は、ユーザーがデスクトップおよびモバイルの異なるメニューページにアクセスする権限を制御します。
![](https://static-docs.nocobase.com/202501031620717.png)

### データ権限

NocoBaseは、ユーザーがシステム内のデータにアクセスする権限を細かく制御し、異なるユーザーが自分の職務に関連するデータのみにアクセスできるようにし、権限の乱用やデータ漏洩を防ぎます。

#### グローバル制御

![](https://static-docs.nocobase.com/202501031620866.png)

#### テーブルレベル、フィールドレベル制御

![](https://static-docs.nocobase.com/202501031621047.png)

#### データ範囲制御

ユーザーが操作できるデータ範囲を設定します。ここで設定するデータ範囲とブロックで設定するデータ範囲は異なることに注意してください。ブロックで設定するデータ範囲は通常、フロントエンドでのデータフィルタリングにのみ使用されます。ユーザーがデータリソースにアクセスする権限を厳密に制御する必要がある場合は、ここで設定し、サーバー側で制御する必要があります。

![](https://static-docs.nocobase.com/202501031621712.png)

## データセキュリティ

データの保存とバックアップの過程で、NocoBaseはデータの安全性を確保するための効果的なメカニズムを提供します。

### パスワード保存

NocoBaseのユーザーパスワードは、scryptアルゴリズムを使用して暗号化されて保存され、大規模なハードウェア攻撃に効果的に対抗できます。

### 環境変数とキー

NocoBaseでサードパーティサービスを使用する場合、サードパーティのキー情報を環境変数に設定し、暗号化して保存することを推奨します。これにより、異なる場所での設定が容易になり、セキュリティが強化されます。詳細な使用方法についてはドキュメントを参照してください。

:::warning
デフォルトでは、キーはAES-256-CBCアルゴリズムを使用して暗号化され、NocoBaseは自動的に32ビットの暗号化キーを生成し、storage/.data/environment/aes_key.datに保存します。ユーザーはキーファイルを適切に保管し、キーファイルが盗まれないようにする必要があります。データを移行する場合、キーファイルも一緒に移行する必要があります。
:::

![](https://static-docs.nocobase.com/202501031622612.png)

### ファイル保存

機密ファイルを保存する必要がある場合は、S3プロトコルに準拠したクラウドストレージサービスを使用し、商用版プラグインFile storage: S3 (Pro)と組み合わせて、ファイルのプライベート読み書きを実現することをお勧めします。内網環境で使用する場合は、MinIOなど、プライベートデプロイメントをサポートし、S3プロトコルに準拠したストレージアプリケーションを使用することをお勧めします。

![](https://static-docs.nocobase.com/202501031623549.png)

### アプリケーションバックアップ

アプリケーションデータの安全性を確保し、データ損失を防ぐために、定期的にデータベースをバックアップすることをお勧めします。

オープンソース版ユーザーは、https://www.nocobase.com/en/blog/nocobase-backup-restore を参照してデータベーストールを使用してバックアップを行い、バックアップファイルを適切に保管してデータ漏洩を防ぐことをお勧めします。

プロフェッショナル版以上のユーザーは、バックアップマネージャーを使用してバックアップを行うことができます。バックアップマネージャーは以下の機能を提供します：

- 定期的な自動バックアップ：定期的に自動バックアップを行い、時間と手間を節約し、データの安全性をさらに確保します。
- バックアップファイルをクラウドストレージに同期：バックアップファイルをアプリケーションサービス自体から分離し、サーバー障害によるサービスの停止と同時にバックアップファイルが失われるのを防ぎます。
- バックアップファイルの暗号化：バックアップファイルにパスワードを設定し、バックアップファイルの漏洩によるデータ漏洩のリスクを低減します。

![](https://static-docs.nocobase.com/202501031623107.png)

## 実行環境セキュリティ

NocoBaseを正しくデプロイし、実行環境のセキュリティを確保することは、NocoBaseアプリケーションの安全性を確保するための重要な要素の一つです。

### HTTPS デプロイ

中間者攻撃を防ぐために、NocoBaseアプリケーションサイトにSSL/TLS証明書を追加し、データがネットワークを介して転送される際の安全性を確保することをお勧めします。

### API 転送暗号化

> エンタープライズ版

データセキュリティ要件がより厳しい環境では、NocoBaseはAPI転送暗号化を